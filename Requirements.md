# 日経225 CFD リスク計算アプリ 要件定義書

## プロジェクト概要
日経225 CFD取引におけるリスク計算を行うアプリケーションを開発する。
ユーザーが指定した仕掛けレンジでの発注計画とリスク分析を提供する。

## 機能要件

### 入力パラメータ
1. **仕掛けレンジ**
   - 開始値（円）
   - 終了値（円）
   - 例: 40,000円〜41,000円

2. **値幅**
   - 各注文間の値幅（円）

3. **取引数量**
   - 各取引の数量（最小単位: 0.1）
   - デフォルト値: 0.1
   - 0.1以上の値を設定可能

4. **現在値**
   - 現在の市場価格（円）
   - 損益計算に使用

5. **ロスカットレート**
   - ロスカット（強制決済）が発生する価格水準（円）

6. **ロスカット幅**
   - ロスカット計算に使用する価格幅（円）
   - デフォルト値: 1980円

7. **証拠金計算**
   - 必要証拠金 = 注文価格 × 取引数量
   - 例: 40,000円での注文、取引数量0.1 → 必要証拠金 4,000円

8. **任意証拠金計算**
   - 任意証拠金 = (注文価格 - ロスカット幅 - ロスカットレート) × 取引数量
   - 例: 注文価格40,000円、ロスカット幅1,980円、ロスカットレート37,000円、数量0.1 → 任意証拠金 102円

9. **損益計算**
   - 損益 = (現在値 - 約定値) × 取引数量
   - 約定値は注文価格と同じ
   - 例: 約定値40,000円、現在値39,500円、数量0.1 → 損益 -50円

### 出力機能
1. **注文一覧表**
   - 開始値から終了値まで、1発注ごとの金額刻みで注文を生成
   - 各注文の詳細情報（価格、金額、数量、必要証拠金、任意証拠金、損益）を一覧表で表示
   - 全体の損益合計も表示

2. **表示形式**
   - 金額の桁区切り表示（カンマ区切り）
   - 例: 40,000円、41,000円
   - 損益は正負の符号付きで表示

### 計算ロジック
1. **注文生成**
   - レンジ = 終了値 - 開始値
   - 注文数 = レンジ ÷ 値幅
   - 各注文価格 = 開始値 + (値幅 × インデックス)

2. **リスク計算**
   - 総発注金額 = 注文数 × 値幅
   - 総必要証拠金 = 各注文の必要証拠金の合計
   - 総任意証拠金 = 各注文の任意証拠金の合計
   - 総証拠金 = 総必要証拠金 + 総任意証拠金
   - 総損益 = 各注文の損益の合計
   - 最大損失想定
   - レンジ外リスク分析

## 非機能要件

### ユーザーインターフェース
- PySide6によるGUIアプリケーション
- 入力バリデーション
- エラーハンドリング

### パフォーマンス
- 即座の計算結果表示
- 大量注文数への対応

### データ形式
- 通貨単位：円
- 数値表示：3桁区切りカンマ
- 小数点：不要（整数のみ）

## 実装プラン

### Phase 1: 基本機能実装
1. **コアロジック開発**
   - 注文計算エンジン
   - リスク計算機能
   - データバリデーション

2. **ユーザーインターフェース**
   - PySide6によるGUI実装
   - 結果表示フォーマット

### Phase 2: 機能拡張
1. **詳細リスク分析**
   - 損益シミュレーション
   - レンジブレイク分析
   - 資金効率計算

2. **出力形式拡張**
   - CSV出力
   - チャート表示（オプション）

### Phase 3: UI改善
1. **PySide6 GUI機能強化**
   - 高度なウィジェット
   - チャート表示
   - テーマ対応

## 技術仕様

### 開発環境
- Python 3.11
- PySide6（GUI フレームワーク）
- パッケージ管理：uv

### アーキテクチャ
```
n225-risk-calc02/
├── main.py              # エントリーポイント
├── src/
│   ├── calculator.py    # リスク計算エンジン
│   ├── validator.py     # 入力バリデーション
│   ├── formatter.py     # 出力フォーマッター
│   ├── models.py        # データモデル
│   └── gui/
│       ├── main_window.py  # メインウィンドウ
│       └── widgets.py      # カスタムウィジェット
├── tests/               # テストコード
└── docs/               # ドキュメント
```

### データ構造
```python
@dataclass
class OrderRange:
    start_price: int     # 開始価格
    end_price: int       # 終了価格
    order_amount: int    # 値幅
    quantity: float      # 取引数量
    current_price: int   # 現在値
    loss_cut_rate: int   # ロスカットレート
    loss_cut_width: int = 1980  # ロスカット幅（デフォルト: 1980）
    
@dataclass
class OrderEntry:
    price: int           # 注文価格
    amount: int          # 発注金額
    quantity: float      # 取引数量
    required_margin: float    # 必要証拠金
    optional_margin: float    # 任意証拠金
    profit_loss: float   # 損益
    
@dataclass
class RiskAnalysis:
    total_orders: int              # 総注文数
    total_amount: int              # 総発注金額
    total_required_margin: float   # 総必要証拠金
    total_optional_margin: float   # 総任意証拠金
    total_margin: float            # 総証拠金（必要＋任意）
    total_profit_loss: float       # 総損益
    order_list: List[OrderEntry]
```

## 成功基準
1. 正確な注文計算の実行
2. 適切な桁区切り表示
3. バリデーションエラーの適切な処理
4. 拡張可能なアーキテクチャの実装

## リスク・課題
1. 大量注文時の計算パフォーマンス
2. 入力値の妥当性検証
3. 数値精度の保証
4. エラーハンドリングの網羅性